{% extends 'base.html' %}
{% load cg_helpers channels i18n notes %}
{% block head-extra %}<script src="{{ STATIC_BASE_URL }}js/jquery.js" type="text/javascript"></script>
<script src="{{ STATIC_BASE_URL }}js/rating.js" type="text/javascript"></script>
<link rel="StyleSheet" type="text/css" href="{{ STATIC_BASE_URL }}css/rating.css">
{% endblock %}
{% block title %}{{ channel.name }} - Miro{%endblock %}
{% block content %}
{% if error %}
<div class="error">{{ error }}</div>
{% endif %}
<div class="channel channel-full">
    {% twocolumns %}
        <div class="screenshot">
            {{ channel.thumb_250_167 }}
            {% if channel.hi_def %}
                <img class="hd-icon-large" src="{{ STATIC_BASE_URL }}images/hd-icon-large.png" alt="HD">
            {% endif %}
        </div>
        <div class="subscribe">
            <a {{ channel.subscription_link }}>
                {% trans "Add Channel to Miro" %}
            </a>
        </div>
        <div id="rating">
            {{ rating_bar }}
        </div>
        <div class="meta">
            <span class="header"></span>
            <div>
                <h3>{% trans "Website" %}</h3>
                {{ channel.website_link }}
            </div>
            <div>
                <h3>{% trans "Categories" %}</h3>
                {% for cat in channel.categories %}
                    {{ cat.link }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </div>
            {% if channel.tags %}
            <div>
                <h3>{% trans "Tags" %}</h3>
                {% for tag in channel.tags %}
                    {{ tag.link }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% if recommendations %}
        <div id="recommendations">
            <h3>{% trans "If you like this channel, try:" %}</h3>
            {% for r in recommendations %}
                {% show_channel_in_recommendation r %}
            {% endfor %}
        </div>
        {% endif %}
    {% splitcolumns %}
        <h1>{{ channel.name }}</h1>
        <div id="description">
            {{ channel.description|escape }}
        </div>
        <div id="description-toggle">Reveal All</div>
        <script type="text/javascript">
            title_height = $("h1").height() + 15; // +15 for margin
            max_height = 177 - title_height;
            description_height = ($("#description").height());
            if (description_height > max_height) { // have to shade
                // find out how high a line is
                var em = $(document.createElement('i')).css({                    
                        'display': 'block',                       
                        'top': '-1em',                   
                        'position': 'absolute',                 
                        'visibility': 'hidden',                      
                        'height': '1em'             
                        });
                $('body').prepend(em);
                line_height = em.height();
                toggle_height = $("#description-toggle").height() + 15; // +15 for margin
                extra = (max_height - toggle_height) % line_height;
                $("#description").height(max_height-toggle_height-extra);
                $("#description-toggle").css("margin-bottom", extra+1);
                $("#description-toggle").show().toggle(function() {
                        $("#description").animate({'height': description_height}, 'slow',
                            function() {$('#description-toggle').text("Hide").addClass("open");});
                        }, function() {
                        $("#description").animate({'height': max_height-toggle_height-extra}, 'slow',
                            function() {$('#description-toggle').text("Reveal All").removeClass("open");});
                    });
            }
        </script>
        {% if items %}
        <div id="episodes">
            <span class="header"></span>
            <h2>{% trans "Episodes" %}</h2>
            <table>
                <tr class="header">
                    <td class="title"><h4>{% trans "Title" %}</h4></td>
                    <td><h4>{% trans "Synopsis" %}</h4></td>
                </tr>
                {% for item in items %}
                    {% show_item item %}
                {% endfor %}
                <script type="text/javascript">
                    if (description_height > max_height) {
                        $("#episodes").css("position", "static");
                    }
                    $(".item:gt(0)").addClass('closed');
                    $(".item .title h4").css('cursor', 'pointer').click(function(){
                            $(this).parent().parent().toggleClass("closed");
                            });
                </script>
            </table>
        </div>
        {% endif %}

        {% if show_extra_info %}
        <ul id="extra-info">
            <li><h3>{% trans "Owner Email" %}</h3>
            {{ channel.owner.email }}</li>
            <li><h3>{% trans "Moderation Status" %}</h3>
            {% blocktrans with channel.state_name as state %}
            Channel is {{ state }}
            {% endblocktrans %}
            {% if channel.last_moderated_by %}
            {% blocktrans with channel.last_moderated_by as mod %}
            (set by {{ mod }})
            {% endblocktrans %}
            {% endif %}
            {% if channel.featured_by %}
                <br/>
                {% trans "Featured by" %} {{ channel.featured_by }}
                {% if channel.featured_at %}
                    at {{ channel.featured_at }}
                {% endif %}
            {% endif %}
        </li></ul>
        {% endif %}

        {% if user.is_moderator or show_edit_button %}
        <div class="clear"></div>
        <ul class="channel-actions">
        {% if user.is_moderator %}
            {% show_moderate_actions channel %}
        {% endif %}
        {% if show_edit_button %}
        <li class="channel-action">
        <form action="#" method="GET" onsubmit="return handleFormLink('{{ channel.get_edit_url }}');">
                <input type="submit" value="{% trans "Edit" %}">
            </form>
        </li>
        {% endif %}
        {% if featured_email_form %}
        <li class="channel-action">
            <h3>{% trans "Featured Channel Notification" %}</h3>
            {% if last_featured_email %}
            Last E-mail sent by <strong>{{ last_featured_email.sender }}</strong> at {{ last_featured_email.timestamp }}
            {% endif %}
            <form method="POST" action="{{ channel.get_url }}">
                {% show_form featured_email_form %}
                <input type="hidden" name="action" value="send-featured-email">
                <ul class="form-inputs">
                    <li>
                        <input type="submit" value="Send">
                    </li>
                </ul>
            </form>
        </li>
        {% endif %}
        </ul>
        {% endif %}
    {% show_channel_notes notes channel %}
    {% endtwocolumns %}
</div>
{% endblock %}
