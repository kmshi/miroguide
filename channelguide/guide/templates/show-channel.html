{% extends 'base.html' %}

{% comment %}
  Copyright (c) 2008 Participatory Culture Foundation
  See LICENSE for details.
{% endcomment %}

{% load cg_helpers channels i18n notes %}

{% block head-extra %}
  <script src="{{ STATIC_BASE_URL }}js/rating.js" type="text/javascript"></script>
  <link rel="StyleSheet" type="text/css" href="{{ STATIC_BASE_URL }}css/rating.css">
  <style type="text/css">
    div#page {
        margin-bottom: 0;
    }

    div#content {
        border-bottom: none;
    }
  </style>
{% endblock %}

{% block title %}{{ channel.name|escape }} - Miro{% endblock %}

{% block content %}
{% if error %}
  <div class="error">{{ error }}</div>
{% endif %}
  <div class="channel channel-full">
    {% if show_edit_button %}
      {% show_edit_bar channel %}
    {% endif %}
    {% twocolumns %}
      <div class="screenshot">
        {% if channel.archived %}
          <div class="archived">{% trans "archival" %}</div>
        {% endif %}
        <a {{ channel.subscription_link }}>{{ channel.thumb_245_164 }}</a>
        {% if channel.hi_def %}
          <img class="hd-icon-large"
               src="{{ STATIC_BASE_URL }}images/hd-icon-large.png" alt="HD">
        {% endif %}
      </div>
      <div class="subscribe">
        <a {{ channel.subscription_link }}>
	  <span class="only-in-miro">
            {% trans "Add Channel to Miro" %}
	  </span>
	  <span class="only-in-browser">
	    {% trans "Subscribe with Miro" %}
	  </span>
        </a>
      </div>
      <div id="rating">
        {{ rating_bar }}
      </div>
      {% if channel.archived %}
        <div class="archived-date">
          {% trans "Archival: no episodes since " %}{{ items.0.date|date:"n/d/Y" }}
        </div>
      {% endif %}
      <div class="meta">
        <span class="header"></span>
        <div>
          <span class="only-in-miro"><h3>{% trans "Website" %}</h3></span>
	  <span class="only-in-browser">
	    <h3>
	      <a {% link channel.url %}><span class="rss-icon"></span></a>
	      {% trans "Website and Feed" %}
            </h3>
          </span>
          <div>
            <span class="only-in-browser">{% trans "site" %}: </span>
            {{ channel.website_link }}
          </div>
	  <div class="only-in-browser">
            {% trans "feed" %}: <a {% link channel.url %}>{% trans "video" %}</a>
          </div>
        </div>
        <div>
          <h3>{% trans "Categories" %}</h3>
          {% for cat in channel.categories %}
            {{ cat.link }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </div>
        {% if channel.tags %}
          <div>
            <h3>{% trans "Tags" %}</h3>
            {% for tag in channel.tags %}
              {{ tag.link }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      </div>
      {% if recommendations %}
        <div id="recommendations">
          <h3>{% trans "If you like this channel, try:" %}</h3>
          {% for r in recommendations %}
            {% show_channel_in_recommendation r forloop.first forloop.last %}
          {% endfor %}
        </div>
      {% endif %}
    {% splitcolumns %}
      <h1>{{ channel.name|escape }}</h1>
      <div id="description">
        {{ channel.description|escape }}
      </div>
      <div id="description-toggle">...read more</div>
      <script type="text/javascript">
         function setHeight(header) {
                 title_height = header.height() + 15; // +15 for margin
                 var max_height = 174 - title_height;
                 var description_height = ($("#description").height());
                 if (description_height > max_height) { // have to shade
                     // find out how high a line is
                     var em = $(document.createElement('i')).css({                    
                             'display': 'block',                       
                             'top': '-1em',                   
                             'position': 'absolute',                 
                             'visibility': 'hidden',                      
                             'height': '1em'             
                             });
                     $('#description').prepend(em);
                     line_height = em.height()*1.32;
                     
                     // for some reason, Miro OSX requires this line
                     document.getElementById('description-toggle').style.display = 'block';
     
                     toggle_height = $("#description-toggle").height() + 27; // +15 for margin
                     extra = (max_height - toggle_height) % line_height;
                     $("#description").height(max_height-toggle_height-extra);
                     $("#description-toggle").css("margin-bottom", extra+25);
                     $("#description-toggle").show().toggle(function() {
                             $("#description").animate({'height': description_height}, 'slow',
                                 function() {$('#description-toggle').text("Hide").addClass("open");});
                             }, function() {
                             $("#description").animate({'height': max_height-toggle_height-extra}, 'slow',
                                 function() {$('#description-toggle').text("...read more").removeClass("open");});
                         });
                 } else if (max_height) {
                     $("#description").height(max_height + 2);
                 }
         }
         function checkHeight() {
             // WebKit doesn't always have the height available right away
             // so, we poll until it is available
             var header = $("h1");
             if (header.height()) {
                 setHeight(header);
             } else {
                 setTimeout("checkHeight()", 10);
             }
         }
         checkHeight();
      </script>
      {% if items %}
        <div id="episodes">
          <div class="rounded"></div>
          <h2>{% trans "Recent Episodes" %}
            <span id="showall">{% trans "Show All" %}</span>
            <span id="sep">/</span>
            <span id="hideall">{% trans "Hide All" %}</span>
          </h2>
          <div class="header">
            <div class="title"><h4>{% trans "Title" %}</h4></div>
            <div><h4>{% trans "Synopsis" %}</h4></div>
          </div>
          {% for item in items %}
            {% show_item item %}
          {% endfor %}
          <script type="text/javascript">
            var openHeight = 160;
            var closedHeight = 15;

            function close(item) {
                item.addClass('closed').animate({'height': closedHeight}, 'slow');
                refreshShowHideAll();
            }

            function open(item) {
                item.removeClass('closed').animate({'height': openHeight}, 'slow');
                refreshShowHideAll();
            }

            function refreshShowHideAll() {
                var showAll = ($(".item.closed").length > 0);
                var hideAll = ($(".item:not(.closed)").length > 0);
                if (showAll) {
                    $('#showall').show();
                } else {
                    $('#showall').hide();
                }
                if (hideAll) {
                    $('#hideall').show();
                } else {
                    $('#hideall').hide();
                }
                if (showAll && hideAll) {
                    $('#sep').show();
                } else {
                    $('#sep').hide();
                }
            }
                   
            $("#episodes").parent().css('position', 'relative');
            close($(".item:gt(0)"));
            $('#showall').click(function() {
                open($('.item'));
            });
            $('#hideall').click(function() {
                close($('.item'));
            });
            $(".item .title h4").click(function(){
                var item = $(this).parent().parent();
                if (item.hasClass('closed')) {
                    open(item);
                } else {
                    close(item);
                }
            });
          </script>
        </div>
      {% endif %}
    {% endtwocolumns %}
  </div>
{% endblock %}
